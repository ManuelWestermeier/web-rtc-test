<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Video &amp; Audio Messaging with Share Link</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f2f2f2; }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 2px 10px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    video { width: 100%; max-width: 380px; background: #000; margin: 10px; }
    textarea, input[type="text"] { width: 100%; margin: 10px 0; padding: 8px; font-family: monospace; }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    label { font-weight: bold; }
    .row { display: flex; flex-wrap: wrap; justify-content: space-around; }
    .column { flex: 1; min-width: 300px; margin: 10px; }
    .instructions { font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <div class="container">
    <h2>WebRTC Video &amp; Audio Messaging</h2>
    <div class="row">
      <div class="column">
        <h3>Local Video</h3>
        <video id="localVideo" autoplay muted></video>
      </div>
      <div class="column">
        <h3>Remote Video</h3>
        <video id="remoteVideo" autoplay></video>
      </div>
    </div>
    <div style="text-align: center;">
      <button id="startButton">Start Camera</button>
      <button id="generateLinkButton">Generate Share Link</button>
      <button id="createAnswerButton">Create Answer</button>
      <button id="connectButton">Connect</button>
    </div>
    <div>
      <label for="shareLink">Share Link (for host to send to a friend):</label>
      <input type="text" id="shareLink" readonly>
    </div>
    <div>
      <label for="localSDP">Local SDP (Offer/Answer):</label>
      <textarea id="localSDP" readonly></textarea>
    </div>
    <div>
      <label for="remoteSDP">Remote SDP:</label>
      <textarea id="remoteSDP"></textarea>
    </div>
    <p class="instructions">
      <strong>Usage:</strong><br>
      1. Open this file in your browser and click “Start Camera”.<br>
      2. If you are the host, click “Generate Share Link” to create an offer. Copy the generated link and send it to your friend.<br>
      3. Your friend should open the link; the offer will load automatically. They then click “Create Answer” which generates an answer (displayed in Local SDP).<br>
      4. The guest copies the answer and sends it back to you. You paste it into the “Remote SDP” field and click “Connect” to finish the setup.
    </p>
  </div>

  <script>
    let localStream, pc;
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const startButton = document.getElementById('startButton');
    const generateLinkButton = document.getElementById('generateLinkButton');
    const createAnswerButton = document.getElementById('createAnswerButton');
    const connectButton = document.getElementById('connectButton');
    const shareLinkInput = document.getElementById('shareLink');
    const localSDPText = document.getElementById('localSDP');
    const remoteSDPText = document.getElementById('remoteSDP');

    // Utility: Get URL parameter (for offer)
    function getUrlParameter(name) {
      name = name.replace(/[[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(window.location.search);
      return results === null ? null : decodeURIComponent(results[1]);
    }

    // Start local camera and mic.
    async function startCamera() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
      } catch (e) {
        alert('Error accessing media devices: ' + e);
      }
    }

    // Create a new RTCPeerConnection and add local tracks.
    function createPeerConnection() {
      pc = new RTCPeerConnection(configuration);

      if (localStream) {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      }

      // When ICE gathering is complete, update the local SDP.
      pc.onicecandidate = event => {
        if (!event.candidate) { // ICE gathering finished
          localSDPText.value = JSON.stringify(pc.localDescription);
        }
      };

      // Display remote stream.
      pc.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
      };
    }

    // Check if the page was opened with an offer in the URL.
    function checkForOfferInUrl() {
      const offerParam = getUrlParameter('offer');
      if (offerParam) {
        try {
          const offer = JSON.parse(offerParam);
          // If an offer exists, prefill the Remote SDP for a joining guest.
          remoteSDPText.value = JSON.stringify(offer, null, 2);
          // Disable the "Generate Share Link" button for joiners.
          generateLinkButton.disabled = true;
        } catch (e) {
          console.error('Invalid offer parameter in URL:', e);
        }
      }
    }

    // Host: Generate an offer and produce a shareable link.
    async function generateShareLink() {
      if (!pc) createPeerConnection();
      try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        // Wait for ICE gathering to complete
        const checkIceComplete = () => {
          if (pc.iceGatheringState === 'complete') {
            const offerSDP = JSON.stringify(pc.localDescription);
            // Encode the offer in the URL parameter
            const encodedOffer = encodeURIComponent(offerSDP);
            const currentUrl = window.location.href.split('?')[0];
            const shareLink = `${currentUrl}?offer=${encodedOffer}`;
            shareLinkInput.value = shareLink;
          } else {
            setTimeout(checkIceComplete, 100);
          }
        };
        checkIceComplete();
      } catch (e) {
        console.error('Error generating share link:', e);
      }
    }

    // Guest: Create an answer based on the offer in Remote SDP.
    async function createAnswer() {
      if (!pc) createPeerConnection();
      const remoteSDP = remoteSDPText.value;
      if (!remoteSDP) {
        alert('No remote SDP found. Please check the share link.');
        return;
      }
      try {
        const offer = JSON.parse(remoteSDP);
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
      } catch (e) {
        console.error('Error creating answer:', e);
      }
    }

    // Host: Finalize connection using the answer from the guest.
    async function connectRemote() {
      const remoteSDP = remoteSDPText.value;
      if (!remoteSDP) {
        alert('Please paste the remote SDP answer.');
        return;
      }
      try {
        const desc = JSON.parse(remoteSDP);
        await pc.setRemoteDescription(new RTCSessionDescription(desc));
      } catch (e) {
        console.error('Error setting remote description:', e);
      }
    }

    startButton.addEventListener('click', startCamera);
    generateLinkButton.addEventListener('click', generateShareLink);
    createAnswerButton.addEventListener('click', createAnswer);
    connectButton.addEventListener('click', connectRemote);

    // On load, check if there's an offer in the URL (guest mode).
    checkForOfferInUrl();
  </script>
</body>
</html>
